// Copyright 2024 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

{{- range $file := .Files}}
{{- $file_name := .Name }}
// Generated from: {{$file_name}}
{{- $rpcMsgs := dict }}

//
// See /docs/Guide to the SDK.md for information on using this spec.
//
{{range $svc := $file.Services}}
{{- $svcopts := index $svc.Options "privacysandbox.apis.roma.app_api.v1.roma_svc_annotation"}}
//
// {{$svcopts.RomaAppName}} UDF Spec
//

syntax = "proto3";

package {{$svcopts.CppNamespace | replace "::" "." }};

{{if len $svcopts.CsharpNamespace}}option csharp_namespace = "{{$svcopts.CsharpNamespace}}";{{end}}
{{if len $svcopts.GoPackage}}option go_package = "{{$svcopts.GoPackage}}";{{end}}


{{- range $rpc := $svc.MethodsWithOption "privacysandbox.apis.roma.app_api.v1.roma_rpc_annotation"}}
{{- $rpcopts := index $rpc.Options "privacysandbox.apis.roma.app_api.v1.roma_rpc_annotation"}}
{{- $reqType := $rpc.RequestType }}
{{- $respType := $rpc.ResponseType }}
{{- $reqFullType := $rpc.RequestFullType | printf "proto.%s" }}
{{- $respFullType := $rpc.ResponseFullType | printf "proto.%s" }}

//
// UDF: {{$rpc.Name}}
//   {{$rpcopts.Description | wrapWith 75 "\n//   "}}
// request: {{$reqType}}
{{- range $msg := $file.Messages}}
{{- if eq $msg.LongName $reqType}}
{{- $_ := set $rpcMsgs $reqType $reqType}}
{{- if len $msg.Description}}
// {{$msg.Description | wrapWith 75 "\n// "}}
{{- end}}
message {{$msg.LongName}} {
{{- if $msg.HasFields}}
{{- range $fldNum, $fld := $msg.Fields}}
{{- if len $fld.Description}}
  // {{$fld.Description | wrapWith 75 "\n  // "}}
{{- end}}
  {{if eq $fld.Label "repeated"}}repeated {{end}}{{$fld.LongType}} {{$fld.Name}} = {{add $fldNum 1}};
{{- end}}
{{- end}}{{/*fields*/}}
}
{{- end}}
{{- end}}{{/*messages*/}}

// response: {{$respType}}
{{- range $msg := $file.Messages}}
{{- if eq $msg.LongName $respType}}
{{- $_ := set $rpcMsgs $respType $respType}}
{{- if len $msg.Description}}
// {{$msg.Description | wrapWith 75 "\n// "}}
{{- end}}
message {{$msg.LongName}} {
{{- if $msg.HasFields}}
{{- range $fldNum, $fld := $msg.Fields}}
{{- if len $fld.Description}}
  // {{$fld.Description | wrapWith 75 "\n  // "}}
{{- end}}
  {{if eq $fld.Label "repeated"}}repeated {{end}}{{$fld.LongType}} {{$fld.Name}} = {{add $fldNum 1}};
{{- end}}
{{- end}}{{/*fields*/}}
}
{{- end}}
{{- end}}{{/*messages*/}}

{{- end}}{{/*rpcs*/}}
{{- end}}{{/*services*/}}

{{- if len $file.Messages}}
// Messages

{{- range $msg := $file.Messages}}
{{- if eq (len (get $rpcMsgs $msg.LongName)) 0}}
{{- if len $msg.Description}}
// {{$msg.Description | wrapWith 75 "\n// "}}
{{- end}}
message {{$msg.LongName}} {
{{- if $msg.HasFields}}
{{- range $fldNum, $fld := $msg.Fields}}
{{- if len $fld.Description}}
  // {{$fld.Description | wrapWith 75 "\n  // "}}
{{- end}}
  {{if eq $fld.Label "repeated"}}repeated {{end}}{{$fld.LongType}} {{$fld.Name}} = {{add $fldNum 1}};
{{end}}
{{- end}}{{/*fields*/}}
}
{{end}}
{{- end}}
{{- end}}{{/*messages*/}}

{{- if len $file.Enums}}
// Enums

{{- range $enum := $file.Enums}}
{{- if len $enum.Description}}
  // {{$enum.Description | wrapWith 75 "\n  // "}}
{{- end}}
enum {{$enum.LongName}} {
{{- range $val := .Values}}
{{- if len $val.Description}}
  // {{$val.Description | wrapWith 75 "\n  // "}}
{{- end}}
  {{$val.Name}} = {{$val.Number}};
{{- end}}{{/*vals*/}}
}
{{end}}
{{- end}}{{/*enums*/}}

{{end}}{{/*files*/}}
